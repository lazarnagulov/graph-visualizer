<div id="app-header">
  <div class="tab">
    <button class="tablinks active" onclick="openTab(event, 'main-tab', 'app-header-tabs')">Main</button>
    <button class="tablinks" onclick="openTab(event, 'filter-tab', 'app-header-tabs')">Filters</button>
   
    <div id="workspace-controls">
      <!-- <label for="current-workspace">Current Workspace:</label>
      <input type="text" id="current-workspace" value="{{ selected_workspace }}" readonly /> -->

      <button hx-get="/create-workspace/" hx-swap="multi:#app-header:outerHTML,#main-view,#tree-view:outerHTML">CREATE</button>
      <button hx-get="/delete-workspace/" hx-swap="multi:#app-header:outerHTML,#main-view,#tree-view:outerHTML">DELETE</button>
      <button hx-get="/switch-workspace-back/" hx-swap="multi:#app-header:outerHTML,#main-view,#tree-view:outerHTML">BACK</button>
      <button hx-get="/switch-workspace-next/" hx-swap="multi:#app-header:outerHTML,#main-view,#tree-view:outerHTML">NEXT</button>
      
      <!-- Workspace counter -->
      <span id="workspace-counter">{{ current_workspace_index }}/{{ total_workspaces }}</span>
    </div>
  </div>

  <div id="app-header-tabs"
       hx-on::after-settle="addMainViewFunctionality(event)">
    <div id="filter-tab" class="tabcontent">
      <form id="filter-form" hx-post="/filter-graph/" hx-swap="multi:#main-view,#tree-view:outerHTML"
            hx-trigger="submit" class="inline-block" oninput="document.getElementById('filter-error').innerHTML='';">
        <label>Filter:</label>
        <input type="text" name="key" id="filter-key" placeholder="Key" hx-include="#filter-form"/>
        <select name="operator" id="filter-operator" hx-include="#filter-form">
          <option value="==">==</option>
          <option value="!=">!=</option>
          <option value="<">&lt;</option>
          <option value="<=">&lt;=</option>
          <option value=">">&gt;</option>
          <option value=">=">&gt;=</option>
        </select>
        <input type="text" name="value" id="filter-value" placeholder="Value" hx-include="#filter-form"/>
        <button type="submit" id="filter-apply">Apply</button>
        <div class="tooltip">
            <img src="static/images/mark.png" alt="error" class="tooltip-icon" width="20" height="20"/>
            <span class="inline-block tooltiptext" id="filter-error"></span>
        </div>
      </form>
      <div class="inline-block">
          <label for="search-input">Search:</label>
          <input type="text" name="query" id="search-input" placeholder="Search..."/>
          <button type="button" id="search-apply" hx-post="/search-graph/" hx-include="#search-input"
                 hx-swap="multi:#main-view,#tree-view:outerHTML">Apply</button>
      </div>
      <button type="button" id="filter-reload" hx-get="/reload-graph"
              hx-swap="multi:#main-view,#tree-view:outerHTML">Reload</button>
    </div>

    <div id="main-tab" class="tabcontent active">
      <label for="select-visualizer">Select visualizer: </label>
      <select name="plugin_id" id="select-visualizer"
              hx-get="/change-visualizer"
              hx-trigger="change"
              hx-on::before-swap="swapHeadContent(event)"
              hx-swap="multi:#main-view,#tree-view:outerHTML">
        {% for plugin in visualizer_plugins %}
          <option value="{{ plugin.id }}" {% if plugin.id == selected_visualizer %}selected{% endif %}>
            {{ plugin.name }}
          </option>
        {% endfor %}
      </select>

      <label for="select-data-source">Select data source: </label>
      <select name="plugin_id" id="select-data-source"
              hx-get="/change-data-source"
              hx-trigger="change"
              hx-swap="multi:#main-view,#tree-view:outerHTML">
        {% for plugin in data_source_plugins %}
          <option value="{{ plugin.id }}" {% if plugin.id == selected_data_source %}selected{% endif %}>
            {{ plugin.name }}
          </option>
        {% endfor %}
      </select>

      <label for="file-input">Upload File: </label>
      <input type="file" id="file-input" name="file_input"
             hx-post="/upload-data-file/"
             hx-trigger="change"
             hx-swap="multi:#main-view,#tree-view:outerHTML"
             hx-encoding="multipart/form-data">
    </div>
  </div>
</div>

<style>
  #workspace-counter {
      display: inline-block;
      margin-left: 300px;
      font-weight: bold;
      font-size: 1.0rem;
      color: #333;
      vertical-align: middle;
      padding: 0.8rem;
  }
</style>


<script>
  document.body.addEventListener('htmx:configRequest', function (event) {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
    if (csrfToken) {
      event.detail.headers['X-CSRFToken'] = csrfToken;
    }
  });

  // Keep tab switching functionality
  function openTab(event, tabId, tabContainerId) {
    event.target.parentNode.querySelector(".active")?.classList.remove("active");
    event.target.classList.add("active");

    document.querySelector(`#${tabContainerId} > .active`)?.classList.remove("active");
    document.querySelector(`#${tabId}`)?.classList.add("active");
  }

  // Removed D3 visualizer/data source JS as it's now fully server-side
</script>
