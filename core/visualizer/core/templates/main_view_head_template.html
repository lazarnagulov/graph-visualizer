<script>
    function swapHeadContent(event) {
        console.log("swapHeadContent");
        window.getGraphSimulation = undefined;
        if (event.detail.pathInfo.requestPath === "/change-visualizer")
        {
            const tempContainer = document.createElement("div");
            tempContainer.innerHTML = event.detail.serverResponse;

            d3.select(document.head).selectChildren(".plugin-visualizer-head").remove();
            d3.select(document.body).selectChildren(".plugin-visualizer-head").remove();
            d3.select(tempContainer)
                .selectAll(".plugin-visualizer-head")
                .each(function() {
                    let clonedNode = this.cloneNode(true)
                    if (clonedNode.nodeName === "SCRIPT") { // recreate script to force execution
                        const newScript = document.createElement("script");
                        for (const attr of clonedNode.attributes)
                            newScript.setAttribute(attr.name, attr.value);
                        if (!clonedNode.src)
                            newScript.textContent = clonedNode.textContent;

                        document.body.appendChild(newScript); // put at end of body for better coverage
                    }
                    else
                        document.head.appendChild(clonedNode); // other head tags

                    this.remove();
            });

            event.detail.serverResponse = tempContainer.innerHTML;
        }
    }
    function addMainViewFunctionality(event) {
        console.log("adding main view functionality");
        if (!window.getGraphSimulation)
            return;

        let simulation = window.getGraphSimulation()
        // Add a drag behavior.
        d3.selectAll("g.node[drag='true']").call(d3.drag()
            .on("start", dragstarted)
            .on("drag", dragged)
            .on("end", dragended));

        // Reheat the simulation when drag starts, and fix the subject position.
        function dragstarted(event) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            event.subject.fx = event.subject.x;
            event.subject.fy = event.subject.y;
        }

        // Update the subject (dragged node) position during drag.
        function dragged(event) {
            event.subject.fx = event.x;
            event.subject.fy = event.y;
        }

        // Restore the target alpha so the simulation cools after dragging ends.
        // Unfix the subject position now that itâ€™s no longer being dragged.
        function dragended(event) {
            if (!event.active) simulation.alphaTarget(0);
            event.subject.fx = null;
            event.subject.fy = null;
        }
    }
</script>