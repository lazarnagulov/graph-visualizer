<style>
    #data-display {
        height: auto;
        width: auto;
        min-height: 20px;
        min-width: 80px;
        padding: 3px;
        background-color: white;
        border: 2px solid black;
        position: fixed;
        z-index: 1;
        visibility: hidden;
        white-space: pre-wrap;
        text-align: center;
    }
</style>

<script>
    window.highlightedTreeNodes = new Set();

    function swapHeadContent(event) {
        window.getGraphSimulation = undefined;
        if (event.detail.pathInfo.requestPath === "/change-visualizer") {
            const tempContainer = document.createElement("div");
            tempContainer.innerHTML = event.detail.serverResponse;

            d3.select(document.head).selectChildren(".plugin-visualizer-head").remove();
            d3.select(document.body).selectChildren(".plugin-visualizer-head").remove();

            d3.select(tempContainer).selectAll(".plugin-visualizer-head").each(function() {
                let clonedNode = this.cloneNode(true);
                if (clonedNode.nodeName === "SCRIPT") {
                    const newScript = document.createElement("script");
                    for (const attr of clonedNode.attributes)
                        newScript.setAttribute(attr.name, attr.value);
                    if (!clonedNode.src) newScript.textContent = clonedNode.textContent;
                    document.body.appendChild(newScript);
                } else {
                    document.head.appendChild(clonedNode);
                }
                this.remove();
            });

            event.detail.serverResponse = tempContainer.innerHTML;
        }
    }

    function addMainViewFunctionality(event) {
        if (!window.getGraphSimulation) {
            console.log("ERROR: Graph simulation does not exist.");
            return;
        }

        const mainDivElements = document.querySelectorAll("[id$='visualizer-main-div']");
        if (mainDivElements.length != 1) {
            console.log("ERROR: There must be exactly one <[visualizer type]visualizer-main-div> element.");
            return;
        }

        const visualizerContainer = document.getElementById("visualizer-container");
        if (!visualizerContainer || visualizerContainer.tagName != "svg") {
            console.log("ERROR: There must be exactly one <svg id=\"visualizer-container\"> element.");
            return;
        }

        let simulation = window.getGraphSimulation();

        // --- Drag functionality ---
        d3.selectAll("g.node[drag='true']").call(d3.drag()
            .on("start", dragstarted)
            .on("drag", dragged)
            .on("end", dragended));
      
        // Zoom and pan functionality logic.
        (function initZoom() {
            d3.select("#visualizer-container").call(d3.zoom().on("zoom", e => calculateZoom(e)));
            //d3.selectAll("g[zoom-and-pan='true']").attr("transform", e.transform)));
            //d3.selectAll("svg").call(d3.zoom().on("zoom", e => d3.selectAll("g[zoom-and-pan='true']").attr("transform", e.transform)));
            // d3.zoom().on("zoom") recognizes the zoom event and applies the transformation it gets to the appropriate <g> elements.
        })();

        function calculateZoom(e) {
            d3.selectAll("g[zoom-and-pan='true']").attr("transform", e.transform);
            updateViewport();
        }

        // "Mouse over" functionality logic.

        // --- Click to highlight tree node ---
        d3.selectAll("g.node[drag='true']").on("click", (event, d) => {
            if (!d || !d.id) return;

            // Reset all main view nodes to default color
            document.querySelectorAll(".node").forEach(n => n.setAttribute("fill", "black"));

            // Highlight clicked main view node
            const mainNode = document.getElementById(d.id);
            if (mainNode) mainNode.setAttribute("fill", "green");

            // Reset previous highlights in Tree view
            if (window.resetTreeHighlights) window.resetTreeHighlights();

            // Highlight node in Tree view
            if (window.highlightTreeNode) window.highlightTreeNode(d.id);

            // Highlight node in Bird view
            if (window.highlightBirdNode) {
                window.highlightBirdNode(d.id);
            } else {
                const birdNode = document.getElementById("bvn-" + d.id);
                if (birdNode) {
                    document.querySelectorAll(".bird-view-node").forEach(n => n.setAttribute("fill", "#A00"));
                    birdNode.setAttribute("fill", "green");
                }
            }
        });

        // --- Mouse over/out ---
        
        // Zoom and pan functionality logic.
        (function initZoom() {
            d3.select("#visualizer-container").call(d3.zoom().on("zoom", e => calculateZoom(e)));
            //d3.selectAll("g[zoom-and-pan='true']").attr("transform", e.transform)));
            //d3.selectAll("svg").call(d3.zoom().on("zoom", e => d3.selectAll("g[zoom-and-pan='true']").attr("transform", e.transform)));
            // d3.zoom().on("zoom") recognizes the zoom event and applies the transformation it gets to the appropriate <g> elements.
        })();

        function calculateZoom(e) {
            d3.selectAll("g[zoom-and-pan='true']").attr("transform", e.transform);
            updateViewport();
        }

        // "Mouse over" functionality logic.
        d3.selectAll("*[mouse-over='true']").attr("onmouseover", d => `mouseOver(${JSON.stringify(d)})`);
        d3.selectAll("*[mouse-over='true']").attr("onmouseout", d => `mouseOut()`);

        const dataDisplay = document.createElement("div");
        dataDisplay.id = "data-display";
        mainDivElements[0].appendChild(dataDisplay);

        function dragstarted(event) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            event.subject.fx = event.subject.x;
            event.subject.fy = event.subject.y;
        }
        function dragged(event) {
            event.subject.fx = event.x;
            event.subject.fy = event.y;
        }
        function dragended(event) {
            if (!event.active) simulation.alphaTarget(0);
            event.subject.fx = null;
            event.subject.fy = null;
        }

        function mouseOver(element) {
            const properties = element.properties;
            let text = "";
            const dataDisplay = document.getElementById("data-display");

            if ("id" in element) {
                for (const key in properties) {
                    if (Object.keys(properties).length === 2 && "type" in properties && "value" in properties) {
                        text += `${properties["value"]}\n`;
                        break;
                    } else {
                        text += `${key}: ${properties[key]}\n`;
                    }
                }
                const nodeBounds = document.getElementById(element.id).getBoundingClientRect();
                dataDisplay.style.left = `${nodeBounds.left + nodeBounds.width / 2 + 70}px`;
                dataDisplay.style.top = `${nodeBounds.top}px`;
            } else {
                for (const key in properties) {
                    if (Object.keys(properties).length === 1 && typeof(properties[key]) === "boolean") {
                        text += `${key}\n`;
                        break;
                    } else {
                        text += `${key}: ${properties[key]}\n`;
                    }
                }
                const sourceBounds = document.getElementById(element.source.id).getBoundingClientRect();
                const targetBounds = document.getElementById(element.target.id).getBoundingClientRect();
                dataDisplay.style.left = `${(sourceBounds.left + targetBounds.left)/2}px`;
                dataDisplay.style.top = `${(sourceBounds.top + targetBounds.top)/2}px`;
            }

            dataDisplay.textContent = text;
            dataDisplay.style.visibility = "visible";
        }
        window.mouseOver = mouseOver;

        function mouseOut() {
            const dataDisplay = document.getElementById("data-display");
            dataDisplay.style.visibility = "hidden";
        }
        window.mouseOut = mouseOut;
    }
</script>
