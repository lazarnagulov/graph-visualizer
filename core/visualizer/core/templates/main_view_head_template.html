<script>
    function swapHeadContent(event) {
        window.getGraphSimulation = undefined;
        if (event.detail.pathInfo.requestPath === "/change-visualizer")
        {
            const tempContainer = document.createElement("div");
            tempContainer.innerHTML = event.detail.serverResponse;

            d3.select(document.head).selectChildren(".plugin-visualizer-head").remove();
            d3.select(document.body).selectChildren(".plugin-visualizer-head").remove();
            d3.select(tempContainer)
                .selectAll(".plugin-visualizer-head")
                .each(function() {
                    let clonedNode = this.cloneNode(true)
                    if (clonedNode.nodeName === "SCRIPT") { // recreate script to force execution
                        const newScript = document.createElement("script");
                        for (const attr of clonedNode.attributes)
                            newScript.setAttribute(attr.name, attr.value);
                        if (!clonedNode.src)
                            newScript.textContent = clonedNode.textContent;

                        document.body.appendChild(newScript); // put at end of body for better coverage
                    }
                    else
                        document.head.appendChild(clonedNode); // other head tags

                    this.remove();
            });

            event.detail.serverResponse = tempContainer.innerHTML;
        }
    }
    function addMainViewFunctionality(event) {
        if (!window.getGraphSimulation) {
            console.log("ERROR: Graph simulation does not exist.");
            return;
        }

        const mainDivElements = document.querySelectorAll("[id$='visualizer-main-div']");
        if (mainDivElements.length != 1) {
            console.log("ERROR: There must be exactly one <[visualizer type]visualizer-main-div> element.");
            return;
        }

        let simulation = window.getGraphSimulation();

        // Drag functionality logic.
        d3.selectAll("g.node[drag='true']").call(d3.drag()
            .on("start", dragstarted)
            .on("drag", dragged)
            .on("end", dragended));
        
        // Zoom and pan functionality logic.
        (function initZoom() {
            d3.select("svg").call(d3.zoom().on("zoom", e => d3.selectAll("g[zoom-and-pan='true']").attr("transform", e.transform)));
            // d3.zoom().on("zoom") recognizes the zoom event and applies the transformation it gets to the appropriate <g> elements.
        })();

        // "Mouse over" functionality logic.
        d3.selectAll("*[mouse-over='true']").attr("onmouseover", d => `mouseOver(${JSON.stringify(d)})`);
        d3.selectAll("*[mouse-over='true']").attr("onmouseout", d => `mouseOut()`)

        const dataDisplay = document.createElement("div");
        dataDisplay.id = "data-display";
        mainDivElements[0].appendChild(dataDisplay);

        // Reheat the simulation when drag starts, and fix the subject position.
        function dragstarted(event) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            event.subject.fx = event.subject.x;
            event.subject.fy = event.subject.y;
        }

        // Update the subject (dragged node) position during drag.
        function dragged(event) {
            event.subject.fx = event.x;
            event.subject.fy = event.y;
        }

        // Restore the target alpha so the simulation cools after dragging ends.
        // Unfix the subject position now that itâ€™s no longer being dragged.
        function dragended(event) {
            if (!event.active) simulation.alphaTarget(0);
            event.subject.fx = null;
            event.subject.fy = null;
        }
    }
</script>